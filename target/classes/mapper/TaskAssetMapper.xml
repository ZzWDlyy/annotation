<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.slowcoder.annotation.mapper.TaskAssetMapper">

    <!-- å¢åŠ  useGeneratedKeys å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†ä¹ æƒ¯åŠ ä¸Š -->
    <select id="findAssetsForGrab" resultType="com.slowcoder.annotation.entity.TaskAsset">
        SELECT t.*
        FROM task_asset t
        WHERE t.task_id = #{taskId}
        AND t.status = 0
        AND (
        t.labeled_count + (
        SELECT COUNT(*)
        FROM task_assignment ta
        WHERE ta.asset_id = t.id
        AND ta.status = 0
        )
        ) &lt; #{targetCount}

        -- æ’é™¤å½“å‰ç”¨æˆ·å·²æ ‡è¿‡çš„
        AND NOT EXISTS (
        SELECT 1 FROM annotation_record ar
        WHERE ar.asset_id = t.id AND ar.user_id = #{userId}
        )

        -- æ’é™¤å½“å‰ç”¨æˆ·æ­£åœ¨æ ‡çš„
        AND NOT EXISTS (
        SELECT 1 FROM task_assignment ta2
        WHERE ta2.asset_id = t.id
        AND ta2.user_id = #{userId}
        AND ta2.status = 0
        )

        ORDER BY t.id ASC  -- æ”¹ä¸ºé¡ºåºï¼Œé¿å… RAND() æ€§èƒ½é—®é¢˜
        LIMIT #{limit}
        FOR UPDATE;  -- ğŸ”¥ å…³é”®ï¼é”ä½è¿™äº›è¡Œ
    </select>


</mapper>
